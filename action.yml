name: 'env'
description: 'Share variables between spaceporn dependencies workflows'
inputs:
  repository:
    description: 'The repository name'
    required: false
    default: "${{ github.repository }}"
  ref:
    description: 'The ref used by the repository'
    required: false
    default: 'trunk'
runs:
  using: "composite"
  steps:
    - name: Install yq on Windows
      if: runner.os == 'Windows'
      id: install
      shell: bash
      run: |
        if choco install yq || scoop install main/yq || winget install --id MikeFarah.yq
        then
          printf 'succeed=true\n'
        else
          printf 'succeed=false\n'
        fi >> "${GITHUB_OUTPUT}"

    - if: runner.os == 'Windows' && steps.install.outputs.succeed != 'true'
      uses: actions/setup-go@v5

    - name: Install yq with GO on Windows
      if: runner.os == 'Windows' && steps.install.outputs.succeed != 'true'
      shell: bash
      run: |
        go install github.com/mikefarah/yq/v4@latest

    - uses: actions/checkout@v4
      with:
        repository: "${{ inputs.repository }}"
        ref: "${{ inputs.ref }}"

    - name: Load environment
      env:
        FILTER: '. | to_entries | map([.key, .value] | join ("=")) | .[]'
      shell: bash
      run: |
        yq "${FILTER}" "${GITHUB_ACTION_PATH}/env.yml" >> "${GITHUB_ENV}"
